#### 五.Hystrix断路器

##### 1.服务雪崩

​	多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C有吊用其他的微服务，这就是所谓的**扇出**，如果**扇出**的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的资源，进而引起系统崩溃，也就是所谓的**雪崩效应**

​	对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源在几分钟内饱和，比失败更糟糕的是这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障，这些都表示需要对故障和延迟进行隔离和管理，以便于单个依赖关系的失败，不能取消整个应用程序或系统

​	**Hystrix**是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统中，许多依赖不可避免的会调用失败，比如超时，异常等，**Hystrix**是能够保证在一个依赖出现问题时，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性

​	断路器本身是一个开关装置，当某一个服务单元发生故障之后，通过锻炼撸起的故障监控（类似于熔断保险丝），向调用方返回一个符合预期的，可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间，无必要的的占用，从而避免的故障遭分布式系统中的蔓延，乃至雪崩

##### 2.**服务熔断**

​	熔断机制是应对雪崩效应的一种微服务链路保护机制

​	当扇出链路的某个服务不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误信息，当检测到该节点微服务调用响应正常之后恢复调用链路，在SpringBoot框架里熔断机制通过Hystrix实现，**Hystrix**会监控微服务间调用的状况，当失败的调用到一定的阈值，默认是5秒内20次调用失败就会启动熔断机制（注解是@HystrixCommand）

##### 3.服务降级

​	当整体的资源不够用的时候，将某些服务先行关掉，等资源充足之后，在开启回来

​	服务降级是在客户端事先完成的，与服务端没有关系

##### 4.服务熔断和服务降级小总结

​	**服务熔断**

​		一般是某个服务故障或者异常引起，类似于现实世界中的保险丝，当某个异常条件被触发的时候，直接熔断整个服务，而不是一直等到此服务超时

​		有了熔断要有降级的原因：

​			SpringCloud两个重要的技术IOC和AOP，AOP就是相向切面的编程，说白了就是要将主业务跟异常处理做成一个切面，用植入的方式润物细无声的执行异常处理，也就是说业务逻辑中就不应该带着这么多横切向的异常处理信息，实现主业务方法和异常处理方法解耦，这是第一步，第二步就是要避免方法膨胀，将所有的异常处理方法写一个接口进行统一的管理，

​	**服务降级**

​		所谓降级，一般是从整体复核考虑，就是当某个服务熔断之后，服务器将不再被调用，此时客户端可以自己准备一个本地的fallback回调，返回一个缺省值，这样做，虽然服务水平下降，但好歹可用，比直接挂掉强

所以从上述分析来看，两者其实从有些角度看是有一定的类似性的：
目的很一致，都是从可用性可靠性着想，为防止系统的整体缓慢甚至崩溃，采用的技术手段；
最终表现类似，对于两者来说，最终让用户体验到的是某些功能暂时不可达或不可用；
粒度一般都是服务级别，当然，业界也有不少更细粒度的做法，比如做到数据持久层（允许查询，不允许增删改）；
自治性要求很高，熔断模式一般都是服务基于策略的自动触发，降级虽说可人工干预，但在微服务架构下，完全靠人显然不可能，开关预置、配置中心都是必要手段；
而两者的区别也是明显的：
触发原因不太一样，服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；
管理目标的层次不太一样，熔断其实是一个框架级的处理，每个微服务都需要（无层级之分），而降级一般需要对业务有层级之分（比如降级一般是从最外围服务开始）
实现方式不太一样，这个区别后面会单独来说；

​	https://blog.csdn.net/guwei9111986/article/details/51649240/

##### 5.服务监控hystrixDashboard(豪猪)

​	除了隔离依赖服务的调用之外，Hystrix还提供了准实时的调用监控（**Hystrix  Dashboard**），Hystrix会持续的记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形的形式，展现给用户，包括每秒执行多少请求多少成功，多少失败等等，Netflix通过hystrix-metrics-event-stream项目实现了对以上指标的监控，SpringCloud也提供了Hystrix  Dashboard的整合，对监控内容转化为可视化页面

![image-20191226100526078](%E4%BA%94.Hystrix%E6%96%AD%E8%B7%AF%E5%99%A8.assets/image-20191226100526078.png)

​	Delay：该参数用来控制服务器上轮询监控信息的延迟时间，默认为2000毫秒，可以通过配置该属性来降低客户端网络和CPU消耗

​	Title：该参数对应了头部标题Hystrix  Stream之后的内容，默认会使用具体监控实例的URL，可以通过配置该信息来展示更合适的标题

![image-20191226100859695](%E4%BA%94.Hystrix%E6%96%AD%E8%B7%AF%E5%99%A8.assets/image-20191226100859695.png)

​	实心圆：共有两种含义，他通过颜色的变化代表了实例的健康程度，他的健康从绿色<黄色<橙色<红色递减，该实心圆出来了颜色的变化外，他的大小也会根据实例的请求流量发生变化，流量越大该实心圆就越大，所以通过该实心圆的展示，就可以在大量的实例中快速的发现故障实例和高压力实例

![image-20191226101407062](%E4%BA%94.Hystrix%E6%96%AD%E8%B7%AF%E5%99%A8.assets/image-20191226101407062.png)

![image-20191226101429453](%E4%BA%94.Hystrix%E6%96%AD%E8%B7%AF%E5%99%A8.assets/image-20191226101429453.png)

​	多个微服务

![image-20191226101531208](%E4%BA%94.Hystrix%E6%96%AD%E8%B7%AF%E5%99%A8.assets/image-20191226101531208.png)









